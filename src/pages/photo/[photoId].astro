---
import Layout from '../../layouts/Layout.astro';
import { client, type Photo, type Category } from '../../lib/microcms';
import kumin from "@assets/img/kuu-icon.png"
import Menu from "../../components/global/Menu.astro";
export async function getStaticPaths() {
  const response = await client.getList<Photo>({
    endpoint: 'photo',
    queries: { limit: 100 }, // 全件取得（必要に応じて増やす）
  });
  return response.contents.map((photo) => ({
    params: { photoId: photo.id },
    props: { photo },
  }));
}
// microCMSからcategoryデータを取得
const categoryResponse = await client.getList<Category>({
  endpoint: 'category',
  queries: { limit: 100 },
});

const categories = categoryResponse.contents;

const { photo } = Astro.props;

// 日付をYYYY/MM/DD形式にフォーマット
const formatDate = (dateString: string) => {
  const date = new Date(dateString);
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}/${month}/${day}`;
};

const createdAt = formatDate(photo.createdAt);
---

<Layout>

  <Menu />
  <!-- 背景用キャンバス（葉の影エフェクト） -->
  <canvas id="leaf-shadow-canvas"></canvas>
  <!-- 時間帯に応じた背景オーバーレイ -->
  <div id="time-overlay" class="time-overlay"></div>
  <main class="photo-detail">
    <div class="photo-detail-wrapper">
      <div class="photo-detail-body">
        <div class="photo-detail__image" id="bulge-container" data-image-url={photo.image.url}>
          <!-- WebGLでレンダリングされる -->
        </div>
      <div class="photo-detail-content">
        {photo.date ?
          <p class="photo-detail-date" set:html={photo.date} ></p>
          :
          <p class="photo-detail-date">{createdAt}</p>
        }
        {photo.title &&
          <h1 set:html={photo.title} ></h1>
        }

        {photo.text &&
            <div class="photo-detail-text" set:html={photo.text} />
        }

        {photo.camera &&
          <p class="photo-detail-camera">
            <Fragment set:html={photo.camera} />
          </p>
        }
        {photo.category?.data && <p class="photo-category">{photo.category.data}</p>}
        <p class="back-btn">
          <a href="/photo/">
            一覧へ戻る
          </a>
        </p>
      </div>
      </div>
    </div>
    <p class="copy-right">
        ©Photoire 2026
    </p>
  </main>
</Layout>

<style>

  /* 背景用キャンバス */
  #leaf-shadow-canvas {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    z-index: -1;
    pointer-events: none;
  }

  .photo-detail {
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    box-sizing: border-box;
  }
  .photo-detail-date{
    font-size:calc(16 / 16 * 1rem) ;
    margin-bottom: calc(20 / 16 * 1rem) ;
    font-weight: 500;
  }
  .photo-detail-camera{
    margin-block: calc(40 / 16 * 1rem) ;
  }
  @media (min-width:768px) {
    .photo-detail-camera{
      margin-block: calc(40 / 16 * 1rem) ;
    }
  }
  .photo-detail__image {
    position: relative;
    width: 100%;
    aspect-ratio: 1/1;
    overflow: hidden;
  }
.photo-detail-text{
  margin-top:calc(24 / 16 * 1rem) ;
  font-weight: 400;
  line-height: 2;
}
@media (min-width:768px) {
.photo-detail-text{
  margin-top:calc(40 / 16 * 1rem) ;
  font-weight: 400;
}
}
.photo-detail-text p + p{
  margin-top:1rem;
}
  .photo-detail__image canvas {
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    height: 100% !important;
    object-fit: cover;
  }
  .photo-detail-content{
    margin-top:calc(40 / 16 * 1rem)
  }
  @media (min-width:768px) {
    .photo-detail-content{
    margin-top:calc(84 / 16 * 1rem);
  }
}
  .photo-detail-content h1{
    font-family: var(--ff-jp2);
    font-weight: 400;
    margin-top:calc(24 / 16 * 1rem);
    font-size : calc(24 / 16 * 1rem);
  }
@media (min-width:768px) {
  .photo-detail-content h1{
    font-family: var(--ff-jp2);
    font-weight: 400;
    margin-top:calc(24 / 16 * 1rem);
    font-size : calc(24 / 16 * 1rem);
  }
}
  .back-btn{
    margin-top: calc(80 / 16 * 1rem) ;
    text-align: center;
    }
  .back-btn a{
    display: inline-block;
    padding-block: calc(12 / 16 * 1rem) ;
    padding-inline: calc(20 / 16 * 1rem) ;
    font-size: calc(14 / 16 * 1rem) ;
    background-color: #202020;
    color: #fff;
    transition: color .4s ease, background-color .4s ease;
  }
   .back-btn a:hover{
    color:#202020 ;
    background-color: #fff;
   }
.photo-detail-body{
  margin-top: calc(136 / 16 * 1rem) ;
}
  @media (min-width:768px) {
  .photo-detail-body{
    display: grid;
    column-gap:80px ;
    margin-top: calc(0 / 16 * 1rem) ;
    grid-template-columns: min(calc(600 / 1440 * 100vw),600px) 1fr;
  }
  }
  .photo-detail-wrapper{
    padding-inline:calc(26 / 16 * 1rem) ;
    box-sizing: content-box;
    max-inline-size: 1046px;
    margin-inline: auto;
  }
  .photo-category{
    display: inline-block;
    background-color: #BFBFBF;
    font-weight: 700;
    line-height: 1;
    padding: calc(8 / 16 * 1rem) calc(12 / 16 * 1rem);
    font-size: calc(14 / 16 * 1rem);
    font-family: var(--ff-jp2);
    font-weight: 700;
  }

  /* 時間帯オーバーレイ */
  .time-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    z-index: -1;
    pointer-events: none;
  }

  /* 朝 (5:00 - 10:00) */
  .time-overlay.is-morning {
    background: linear-gradient(69.03deg, rgba(255, 253, 253, 0.2) 0.81%, #C3F1FF 100%);
    opacity: 0.2;
  }

  /* 昼 (10:00 - 17:00) */
  .time-overlay.is-daytime {
    background: linear-gradient(69.03deg, rgba(255, 253, 253, 0.2) 0.81%, #C3F1FF 100%);
    opacity: 0.2;
  }

  /* 夕方 (17:00 - 19:00) */
  .time-overlay.is-evening {
    background: linear-gradient(69.03deg, rgba(255, 253, 253, 0.2) 0.81%, #FFC0A1 100%);
    opacity: 0.2;
  }

  /* 夜 (19:00 - 5:00) */
  .time-overlay.is-night {
    background: linear-gradient(69.03deg, rgba(255, 253, 253, 0.2) 0.81%, #040404 100%);
    opacity: 0.5;
  }
  .copy-right{
    position: absolute;
    bottom: calc(24 / 16 * 1rem) ;
    inset-inline: 0;
    text-align: center;
    margin-inline: auto;
    font-size: calc(14 / 16 * 1rem) ;
    letter-spacing: .08em;
  }

</style>

<script>
  import { initMenuController } from '../../assets/js/libs/MenuController';
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => initMenuController());
  } else {
    initMenuController();
  }
</script>
