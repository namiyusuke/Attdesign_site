---
import Layout from '../layouts/Layout.astro';
import { client, type Photo } from '../lib/microcms';

// microCMSからphotoデータを取得
const response = await client.getList<Photo>({
  endpoint: 'photo',
  queries: { limit: 25 },
});

const photos = response.contents;

// WebGLに渡すデータ（画像URLとリンク先）
const photoData = photos.map(p => ({
  imageUrl: p.image.url,
  linkUrl: `/photo#photo-${p.id}`,
}));
---

<Layout>
  <!-- イントロアニメーション用オーバーレイ -->
<div id="intro-overlay" class="intro-overlay"></div>
<!-- 写真フライアウト用オーバーレイ -->
<div id="photo-overlay" class="photo-overlay">
  <img id="photo-overlay-img" class="photo-overlay__img" src="" alt="" />
    </div>
	<canvas id="webgl"></canvas>
</Layout>

<script is:inline define:vars={{ photoData }}>
  window.__PHOTO_DATA__ = photoData;
</script>
<script>
	import { WebGL } from "@assets/js/libs/WebGL";

  let webglInstance: WebGL | null = null;

  function initWebGL(skipIntro = false) {
    const canvas = document.getElementById("webgl") as HTMLCanvasElement;
    if (canvas) {
      // 既存のインスタンスがあれば破棄
      if (webglInstance) {
        webglInstance.destroy();
      }
      webglInstance = new WebGL(canvas, skipIntro);
    }
  }

  // 初回読み込み時
  initWebGL(false);

  // swupでページ遷移後に再初期化（イントロはスキップ）
  if (window.swup) {
    window.swup.hooks.on('page:view', () => {
      initWebGL(true);
    });
  }
</script>
